<!DOCTYPE html>
<html>
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="LoanApp">
<link rel="apple-touch-icon" href="icon-192.png">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Management System</title>

<style>
*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,system-ui,sans-serif;
  background:#f1f5f9;
  -webkit-text-size-adjust:100%;
  color:#111827;
}

/* ===== HEADER ===== */

.header{
  background:#2563eb;
  color:#fff;
  padding:16px;
  text-align:center;
  font-size:18px;
  font-weight:600;
  position:sticky;
  top:0;
  z-index:10;
}

/* ===== MAIN CONTAINER ===== */

.container{
  max-width:480px;
  margin:auto;
  padding:16px;
  padding-bottom:100px;
}

/* ===== SECTION TITLE ===== */

.section-title{
  font-size:14px;
  font-weight:600;
  color:#374151;
  margin:22px 0 10px;
  letter-spacing:0.3px;
}

/* ===== CARD ===== */

.card{
  background:#ffffff;
  border-radius:16px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 3px 12px rgba(0,0,0,0.04);
}

/* ===== STAT CARDS (Dashboard Top) ===== */

.card b{
  font-size:16px;
}

#totalMembersCard,
#activeBorrowersCard,
#activeLoansCard,
#completedLoansCard{
  font-size:15px;
  font-weight:600;
}

/* ===== INPUTS ===== */

input{
  width:100%;
  padding:14px;
  border-radius:12px;
  border:1px solid #e5e7eb;
  margin-bottom:12px;
  font-size:15px;
  background:#fff;
}

input:focus{
  outline:none;
  border:1px solid #2563eb;
}

/* ===== BUTTONS ===== */

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  background:#2563eb;
  color:white;
  font-weight:600;
  font-size:15px;
  min-height:48px;
  cursor:pointer;
  transition:0.2s;
}

button:active{
  transform:scale(0.98);
}

button.green{
  background:#16a34a;
}

button.secondary{
  background:#1e40af;
}

/* ===== STATUS BADGES ===== */

.status{
  display:inline-block;
  margin-top:8px;
  padding:6px 12px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
}

.pending{
  background:#fef3c7;
  color:#92400e;
}

.overdue{
  background:#fee2e2;
  color:#991b1b;
}

.completed{
  background:#dcfce7;
  color:#166534;
}

/* ===== SMALL TEXT ===== */

.small-text{
  font-size:13px;
  color:#6b7280;
  margin-top:6px;
}

/* ===== REPORT TABLE ===== */

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th{
  text-align:left;
  padding:10px 8px;
  font-size:12px;
  letter-spacing:0.5px;
  text-transform:uppercase;
  background:#f3f4f6;
  color:#374151;
}

td{
  padding:10px 8px;
  border-bottom:1px solid #e5e7eb;
}

/* ===== NAVIGATION ===== */

.nav{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:65px;
  background:#ffffff;
  border-top:1px solid #e5e7eb;
  display:flex;
  align-items:center;
  justify-content:space-around;
  z-index:20;
}

.nav div{
  flex:1;
  text-align:center;
  font-size:13px;
  padding:10px 0;
  color:#6b7280;
}

.nav .active{
  color:#2563eb;
  font-weight:600;
}

/* ===== HIDDEN SECTION ===== */

.hidden{
  display:none;
}

/* ===== SMOOTH SECTION SWITCH ===== */

#dashboardSection,
#borrowerSection,
#reportsSection{
  animation:fadeIn 0.2s ease-in-out;
}

@keyframes fadeIn{
  from{opacity:0;}
  to{opacity:1;}
}

.action-bar{
  display:flex;
  justify-content:center;
  gap:24px;
  margin:20px 0;
}

.icon-btn{
  width:52px;
  height:52px;
  border-radius:50%;
  background:#2563eb;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:22px;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 4px 10px rgba(0,0,0,0.15);
  transition:0.2s;
}

.icon-btn:active{
  transform:scale(0.92);
}


</style>
</head>

<body>

<div class="header">Loan Management System</div>

<div class="container">

<!-- ================= DASHBOARD ================= -->

<div id="dashboardSection">

<div class="section-title">Overview</div>
<div class="grid">
  <div class="card" id="totalMembersCard"></div>
  <div class="card" id="activeBorrowersCard"></div>
  <div class="card" id="activeLoansCard"></div>
  <div class="card" id="completedLoansCard"></div>
</div>

<div class="card" id="totalProfitCard"></div>
<div class="card" id="overdueCountCard"></div>

<div id="dashboardDynamic"></div>

</div>

<!-- ================= BORROWER ================= -->

<div id="borrowerSection" class="hidden">

<div class="section-title">Borrower Management</div>

<div class="action-bar">
  <div class="icon-btn" onclick="toggleAdd()">
    ‚ûï
  </div>

  <div class="icon-btn" onclick="toggleSearch()">
    üîç
  </div>
</div>

<div id="addBorrowerBox" class="card hidden">
  <h4>Add Borrower</h4>
  <input id="name" placeholder="Borrower Name">
  <input id="phone" placeholder="Phone Number">
  <button onclick="addBorrower()">Save Borrower</button>
</div>

<div id="searchBorrowerBox" class="card hidden">
  <h4>Search Borrower</h4>
  <input id="searchPhone" placeholder="Phone Number">
  <button onclick="searchBorrower()">Search</button>
</div>

<div id="profile"></div>

</div>

<!-- ================= REPORTS ================= -->

<div id="reportsSection" class="hidden">

<div class="section-title">Financial Reports</div>

<div class="card">
<input type="date" id="fromDate">
<input type="date" id="toDate">
<button class="secondary" onclick="generateReport()">Generate Report</button>
</div>

<div class="grid" id="reportSummary"></div>

<div class="card">
<table>
<thead>
<tr>
<th>Date</th>
<th>Phone</th>
<th>Type</th>
<th>Amount</th>
</tr>
</thead>
<tbody id="reportTable"></tbody>
</table>
</div>

</div>

</div>

<div class="nav">
<div class="active" onclick="showSection('dashboardSection',this)">Dashboard</div>
<div onclick="showSection('borrowerSection',this)">Borrower</div>
<div onclick="showSection('reportsSection',this)">Reports</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getFirestore, doc, setDoc, getDoc, updateDoc,
  collection, addDoc, getDocs, query, where
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCX4nJv28LRTtCcH3sjj-LUiXzYfxK3SDM",
  authDomain: "loan-management-system-a5bd8.firebaseapp.com",
  projectId: "loan-management-system-a5bd8",
  storageBucket: "loan-management-system-a5bd8.appspot.com",
  messagingSenderId: "29727312343",
  appId: "1:29727312343:web:14e58637f47a0994fde392"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= NAVIGATION ================= */

window.showSection = function(id,el){
  ["dashboardSection","borrowerSection","reportsSection"]
  .forEach(sec=>document.getElementById(sec).classList.add("hidden"));

  document.querySelectorAll(".nav div")
  .forEach(n=>n.classList.remove("active"));

  document.getElementById(id).classList.remove("hidden");
  el.classList.add("active");
};

/* ================= DASHBOARD ================= */

async function loadDashboard(){

  const borrowersSnap = await getDocs(collection(db,"borrowers"));
  const loansSnap = await getDocs(collection(db,"loans"));
  const installmentsSnap = await getDocs(collection(db,"installments"));
  const collectionsSnap = await getDocs(collection(db,"collections"));

  let activeLoans = 0;
  let completedLoans = 0;
  let profit = 0;
  let activeBorrowers = new Set();

  loansSnap.forEach(l=>{
    const loan=l.data();
    if(loan.status==="active"){
      activeLoans++;
      activeBorrowers.add(loan.borrowerPhone);
    }
    if(loan.status==="completed") completedLoans++;
  });

  collectionsSnap.forEach(c=>{
    if(c.data().type==="upfront"){
      profit += c.data().amount;
    }
  });

  document.getElementById("totalMembersCard").innerHTML =
    `Total Members: ${borrowersSnap.size}`;

  document.getElementById("activeBorrowersCard").innerHTML =
    `Active Borrowers: ${activeBorrowers.size}`;

  document.getElementById("activeLoansCard").innerHTML =
    `Active Loans: ${activeLoans}`;

  document.getElementById("completedLoansCard").innerHTML =
    `Completed Loans: ${completedLoans}`;

  document.getElementById("totalProfitCard").innerHTML =
    `Total Profit Earned: ‚Çπ${profit}`;

  /* Due & Overdue */

  const todayStart = new Date(); 
  todayStart.setHours(0,0,0,0);

  const todayEnd = new Date(); 
  todayEnd.setHours(23,59,59,999);

  let dueTodayHTML = "";
  let overdueHTML = "";

  for(const instDoc of installmentsSnap.docs){

    const inst = instDoc.data();
    if(inst.status==="completed") continue;
    if(!inst.dueDate) continue;

    const dueDate = new Date(inst.dueDate);

    if(dueDate >= todayStart && dueDate <= todayEnd){
      dueTodayHTML += `
        <div class="card">
          <b>${inst.borrowerPhone}</b><br>
          Week ${inst.weekNumber} | ‚Çπ${inst.amount}
          <button class="green"
            onclick="markPaid('${instDoc.id}','${inst.loanId}','${inst.borrowerPhone}',${inst.amount})">
            Mark Received
          </button>
        </div>`;
    }

    if(dueDate < todayStart){
      const daysLate = Math.floor((todayStart-dueDate)/(1000*60*60*24));

      overdueHTML += `
        <div class="card">
          <b>${inst.borrowerPhone}</b><br>
          Week ${inst.weekNumber} | ‚Çπ${inst.amount}
          <div style="color:red;font-size:13px">
            ${daysLate} days overdue
          </div>
          <button class="green"
            onclick="markPaid('${instDoc.id}','${inst.loanId}','${inst.borrowerPhone}',${inst.amount})">
            Mark Received
          </button>
        </div>`;
    }
  }

  if(!dueTodayHTML) dueTodayHTML = `<div class="card">No installments due today</div>`;
  if(!overdueHTML) overdueHTML = `<div class="card">No overdue installments</div>`;

  document.getElementById("dashboardDynamic").innerHTML = `
    <div class="section-title">üìÖ Due Today</div>
    ${dueTodayHTML}
    <div class="section-title">üî¥ Overdue</div>
    ${overdueHTML}
  `;
}

/* ================= ADD BORROWER ================= */

window.addBorrower = async function(){
  const name=document.getElementById("name").value.trim();
  const phone=document.getElementById("phone").value.trim();
  if(!name||!phone) return alert("Fill all fields");

  if((await getDoc(doc(db,"borrowers",phone))).exists())
    return alert("Borrower exists");

  await setDoc(doc(db,"borrowers",phone),{name,phone});
  alert("Borrower added");

  document.getElementById("name").value="";
  document.getElementById("phone").value="";
  loadDashboard();
};

window.searchBorrower = async function(){

  const phone = document.getElementById("searchPhone").value.trim();
  if(!phone) return alert("Enter phone");

  const snap = await getDoc(doc(db,"borrowers",phone));
  if(!snap.exists()) return alert("Not found");

  const borrower = snap.data();

  // Hide search form after opening profile
  document.getElementById("searchBorrowerBox").classList.add("hidden");

  const loansSnap = await getDocs(query(
    collection(db,"loans"),
    where("borrowerPhone","==",phone)
  ));

  let activeLoanCount = 0;
  let installmentsLeft = 0;
  let totalBorrowed = 0;
  let totalDueRemaining = 0;

  let loanCardsHTML = "";

  for(const loanDoc of loansSnap.docs){

    const loan = loanDoc.data();
    const loanId = loanDoc.id;

    if(loan.status === "active"){
      activeLoanCount++;
      totalBorrowed += loan.principalAmount;
    }

    const instSnap = await getDocs(query(
      collection(db,"installments"),
      where("loanId","==",loanId)
    ));

    let installments = [];

    instSnap.forEach(d=>{
      installments.push({id:d.id,...d.data()});
    });

    installments.sort((a,b)=>a.weekNumber-b.weekNumber);

    let instHTML="";

    for(const inst of installments){

      if(inst.status !== "completed"){
        installmentsLeft++;
        totalDueRemaining += inst.amount;
      }

      if(inst.status==="pending" && inst.dueDate && Date.now()>inst.dueDate){
        await updateDoc(doc(db,"installments",inst.id),{status:"overdue"});
        inst.status="overdue";
      }

      const due = new Date(inst.dueDate);

      instHTML += `
        <div class="card">
          <b>Week ${inst.weekNumber}</b><br>
          ‚Çπ${inst.amount}<br>
          <div class="small-text">
            Due: ${due.toLocaleDateString()}
          </div>
          <span class="status ${inst.status}">
            ${inst.status}
          </span>
          ${inst.status!=="completed"
            ? `<button class="green"
                 onclick="markPaid('${inst.id}','${loanId}','${phone}',${inst.amount})">
                 Mark Received
               </button>` : ""}
        </div>
      `;
    }

    loanCardsHTML += `
      <div class="card">
        <b>Loan ‚Çπ${loan.principalAmount}</b><br>
        Interest: ‚Çπ${loan.upfrontInterest}
        ${instHTML}
      </div>
    `;
  }

  let html = `
    <div class="card">
      <h4>${borrower.name}</h4>

      <div style="margin-top:6px">
        üìû <a href="tel:${phone}" style="color:#2563eb;text-decoration:none">
          ${phone}
        </a>
      </div>

      <div style="margin-top:6px">
        üí¨ <a href="https://wa.me/${phone}" target="_blank"
          style="color:#16a34a;text-decoration:none">
          WhatsApp
        </a>
      </div>

      <div style="margin-top:14px;font-size:14px">
        Active Loans: <b>${activeLoanCount}</b><br>
        Installments Left: <b>${installmentsLeft}</b><br>
        Total Borrowed (Active): ‚Çπ<b>${totalBorrowed}</b><br>
        Total Due Remaining: ‚Çπ<b>${totalDueRemaining}</b>
      </div>

      <div style="margin-top:16px">
        <button onclick="toggleCreateLoan()">‚ûï Create New Loan</button>
      </div>
    </div>

    <div id="createLoanBox" class="card hidden">
      <input id="principal" placeholder="Principal">
      <input id="interestPercent" placeholder="Interest %">
      <input id="weeks" placeholder="Weeks">
      <button onclick="createLoan('${phone}')">
        Confirm Loan
      </button>
    </div>

    ${loanCardsHTML}
  `;

  document.getElementById("profile").innerHTML = html;
};

/* ================= CREATE LOAN ================= */

window.createLoan = async function(phone){

  const principal=parseFloat(document.getElementById("principal").value);
  const percent=parseFloat(document.getElementById("interestPercent").value);
  const weeks=parseInt(document.getElementById("weeks").value);

  if(!principal||!percent||!weeks) return alert("Fill fields");

  const upfront=(principal*percent)/100;
  const weekly=principal/weeks;
  const start=Date.now();
  const oneWeek=7*24*60*60*1000;

  const loanRef=await addDoc(collection(db,"loans"),{
    borrowerPhone:phone,
    principalAmount:principal,
    interestPercent:percent,
    upfrontInterest:upfront,
    status:"active"
  });

  await addDoc(collection(db,"collections"),{
    loanId:loanRef.id,
    borrowerPhone:phone,
    amount:upfront,
    type:"upfront",
    date:Date.now()
  });

  for(let i=0;i<weeks;i++){
    await addDoc(collection(db,"installments"),{
      loanId:loanRef.id,
      borrowerPhone:phone,
      amount:weekly,
      weekNumber:i+1,
      dueDate:start+((i+1)*oneWeek),
      status:"pending"
    });
  }

  alert("Loan Created");
  searchBorrower();
  loadDashboard();
};

/* ================= MARK PAID ================= */

window.markPaid = async function(instId,loanId,phone,amount){

  await updateDoc(doc(db,"installments",instId),{
    status:"completed",
    paidDate:Date.now()
  });

  await addDoc(collection(db,"collections"),{
    loanId:loanId,
    borrowerPhone:phone,
    amount:parseFloat(amount),
    type:"installment",
    date:Date.now()
  });

  loadDashboard();
  searchBorrower();
};

/* ================= REPORT ================= */

window.generateReport = async function(){

  const fromVal=document.getElementById("fromDate").value;
  const toVal=document.getElementById("toDate").value;

  if(!fromVal||!toVal) return alert("Select both dates");

  const snap=await getDocs(collection(db,"collections"));

  let total=0,upfront=0,install=0,count=0;
  let rows="";

  snap.forEach(doc=>{
    const data=doc.data();
    const recordDateStr=new Date(data.date).toISOString().split("T")[0];

    if(recordDateStr >= fromVal && recordDateStr <= toVal){
      total+=data.amount;
      count++;
      if(data.type==="upfront") upfront+=data.amount;
      else install+=data.amount;

      rows+=`
        <tr>
          <td>${new Date(data.date).toLocaleDateString()}</td>
          <td>${data.borrowerPhone}</td>
          <td>${data.type}</td>
          <td>‚Çπ${data.amount}</td>
        </tr>`;
    }
  });

  if(count===0){
    rows=`<tr><td colspan="4" style="text-align:center">
      No transactions found</td></tr>`;
  }

  document.getElementById("reportSummary").innerHTML=`
    <div class="card">Total: ‚Çπ${total}</div>
    <div class="card">Upfront: ‚Çπ${upfront}</div>
    <div class="card">Installments: ‚Çπ${install}</div>
    <div class="card">Transactions: ${count}</div>
    <div class="card">Principal: ‚Çπ${install}</div>
    <div class="card">Profit: ‚Çπ${upfront}</div>
  `;

  document.getElementById("reportTable").innerHTML=rows;
};


window.toggleAdd = function(){

  const addBox = document.getElementById("addBorrowerBox");
  const searchBox = document.getElementById("searchBorrowerBox");
  const profile = document.getElementById("profile");

  // Clear borrower profile view
  profile.innerHTML = "";

  // Toggle add form
  addBox.classList.toggle("hidden");

  // Always hide search form
  searchBox.classList.add("hidden");
};

window.toggleSearch = function(){

  const addBox = document.getElementById("addBorrowerBox");
  const searchBox = document.getElementById("searchBorrowerBox");
  const profile = document.getElementById("profile");

  // Clear borrower profile view
  profile.innerHTML = "";

  // Toggle search form
  searchBox.classList.toggle("hidden");

  // Always hide add form
  addBox.classList.add("hidden");
};

window.toggleCreateLoan = function(){
  const box = document.getElementById("createLoanBox");
  box.classList.toggle("hidden");
};

/* LOAD ON START */
loadDashboard();

</script>

<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", function() {
    navigator.serviceWorker
      .register("service-worker.js")
      .then(function(registration) {
        console.log("Service Worker registered:", registration.scope);
      })
      .catch(function(error) {
        console.log("Service Worker registration failed:", error);
      });
  });
}
</script>
</body>
</html>